---
title: "SCENIC analysis on Seurat object"
author: "Lucy Garner"
date: "`r Sys.Date()`"
output: html_document
params:
    working_dir: "pyscenic_results.dir"
    seurat_object: "../results/Robjects/GI2792_graft_donor_analysed_v3.rds"
    aucell_scores: "../results/pyscenic/normalised/GI2792-graft-donor_aucell.csv"
    aucell_zscores: "../results/pyscenic/normalised/aucell_zscores.csv"
    aucell_zscores_celltype: "../results/pyscenic/normalised/aucell_zscores_GI2792_graft_donorcells_annotation.csv"
    aucell_zscores_condition: "None"    # None if not available
    binary_matrix: "../results/pyscenic/normalised/binary_matrix.csv"
    results_directory: "../results/pyscenic_r"
    plots_directory: "../plots/pyscenic"
    datatype: normalised
    umap_pcs: 8    # how many PCs to use for clustering on AUCell scores
    cell_type: "cell_annotation"
    condition: "None"      # None if not available
    clustering_resolution: 0.4
    stacked_vln_function: "../Rscripts/functions/stacked_violin.R"
    reference_condition: "None"      # None is not available
    FDR_threshold: 0.001     # FDR threshold for top 10 wilcoxon heatmap
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r Load_packages}
library(Seurat)
library(tidyverse)
library(patchwork)
library(RColorBrewer)
library(gtools)
library(pheatmap)
```

```{r Read_in_data}
seurat_object <- readRDS(params$seurat_object)
aucell_matrix <- read_csv(params$aucell_scores)
aucell_zscore <- read_csv(params$aucell_zscores)
aucell_zscore_celltype <- read_csv(params$aucell_zscores_celltype)
binary_aucell_matrix <- read_csv(params$binary_matrix)
results_directory <- params$results_directory
plots_directory <- params$plots_directory
datatype <- params$datatype
metadata <- as.data.frame(seurat_object@meta.data)

if (params$aucell_zscores_condition != "None") {
    aucell_zscore_condition <- read_csv(params$aucell_zscores_condition)
}

if (params$condition != "None") {
    metadata <- metadata %>%
    rownames_to_column(var = "barcode") %>%
    mutate(!!sym(params$cell_type) := as.character(!!sym(params$cell_type)),
           !!sym(params$condition) := as.character(!!sym(params$condition)))
} else {
    metadata <- metadata %>%
    rownames_to_column(var = "barcode") %>%
    mutate(!!sym(params$cell_type) := as.character(!!sym(params$cell_type)))
}

if (!dir.exists(paste0(plots_directory, "/", datatype))) {
    dir.create(paste0(plots_directory, "/", datatype), recursive = TRUE)
}

if (!dir.exists(paste0(results_directory, "/", datatype))) {
    dir.create(paste0(results_directory, "/", datatype), recursive = TRUE)
}
```

```{r Add_assay}
# Add binary matrix to counts slot, AUCell Z-scores to data slot and AUCell scores to scale.data
binary_aucell_matrix <- binary_aucell_matrix %>%
    column_to_rownames(var = "X1")
binary_aucell_matrix <- t(binary_aucell_matrix)

aucell_zscore <- aucell_zscore %>%
    column_to_rownames(var = "X1")
aucell_zscore <- t(aucell_zscore)

aucell_matrix <- aucell_matrix %>%
    column_to_rownames(var = "Regulon")

# Counts slot in scenic assay will contain AUCell scores
seurat_object[["scenic"]] <- CreateAssayObject(counts = binary_aucell_matrix)

DefaultAssay(seurat_object) <- "scenic"
seurat_object <- SetAssayData(seurat_object, slot = "data", new.data = aucell_zscore)
seurat_object <- SetAssayData(seurat_object, slot = "scale.data", new.data = as.matrix(aucell_matrix))
```

#### AUCell scores on gene expression UMAP/tSNE

```{r Plot_AUCell_scores}
# Plot AUCell scores on the gene expression UMAP
plot_aucell <- function(seurat_object, feature, slot, name = "aucell_score", colours = c("lightgrey", "blue"), reduction) {
    DefaultAssay(seurat_object) <- "scenic"
    pdf(paste0(plots_directory, "/", datatype, "/", feature, "_", name, "_", reduction, ".pdf"))
    print(FeaturePlot(seurat_object, features = feature, slot = slot, cols = colours, reduction = reduction))
    dev.off()
}

# Plot absolute AUCell values and AUCell z-scores
for (regulon in rownames(aucell_matrix)) {
    plot_aucell(seurat_object, regulon, "scale.data", reduction = "umap")
    plot_aucell(seurat_object, regulon, "data", name = "aucell_z_score", reduction = "umap")
}

# Plot binary AUCell scores
plot_binary_aucell <- function(seurat_object, feature, name = "binary_aucell_score", highlight_colour = "red2", reduction) {
    DefaultAssay(seurat_object) <- "scenic"
    pdf(paste0(plots_directory, "/", datatype, "/", feature, "_", name, "_", reduction, ".pdf"))
    print(DimPlot(seurat_object, reduction = reduction, cells.highlight = colnames(binary_aucell_matrix)[binary_aucell_matrix[feature, ] == 1], cols.highlight = highlight_colour) +
              NoLegend())
    dev.off()
}

for (regulon in rownames(aucell_matrix)) {
    plot_binary_aucell(seurat_object, regulon, name = "binary_aucell_score", reduction = "umap")
}

# Same results for tSNE
if ("tsne" %in% names(seurat_object@reductions)) {
    for (regulon in rownames(aucell_matrix)) {
        plot_aucell(seurat_object, regulon, "scale.data", reduction = "tsne")
        plot_aucell(seurat_object, regulon, "data", name = "aucell_z_score", reduction = "tsne")
        plot_binary_aucell(seurat_object, regulon, name = "binary_aucell_score", reduction = "tsne")
    }
}
```

#### PCA and clustering on AUCell scores

```{r PCA_and_clustering}
# Run PCA and UMAP based on the AUCell scores
seurat_object <- RunPCA(seurat_object, assay = "scenic", reduction.name = "scenic_pca",
                        reduction.key = "scenicPC_",
                        features = rownames(GetAssayData(seurat_object, "scale.data")),
                        verbose = FALSE)
ElbowPlot(seurat_object, reduction = "scenic_pca")
seurat_object <- RunUMAP(seurat_object, assay = "scenic", reduction = "scenic_pca",
                         reduction.key = "scenicUMAP_", dims = 1:params$umap_pcs,
                         reduction.name = "scenic_umap", verbose = FALSE)
DimPlot(seurat_object, reduction = "scenic_umap")

if (params$condition != "None") {
    DimPlot(seurat_object, reduction = "scenic_umap", group.by = params$condition)
}

# Perform clustering
seurat_object <- FindNeighbors(seurat_object, assay = "scenic", reduction = "scenic_pca",
                               dims = 1:params$umap_pcs)
seurat_object <- FindClusters(seurat_object, graph.name = "scenic_snn", resolution = as.numeric(params$clustering_resolution))
DimPlot(seurat_object, reduction = "scenic_umap", group.by = params$cell_type, label = T, label.size = 3) + NoLegend()

saveRDS(seurat_object, file = paste0(results_directory, "/", datatype, "/","scenic_seurat_object",".rds"))
```

#### Violin plots split by condition and cell type

```{r Violin_aucell}
# Violin plots of AUCell distributions split by condition or cell type
plot_violin_aucell <- function(seurat_object, feature, group_by, split_by = "None", name = "aucell_score_violin") {
    Idents(seurat_object) <- group_by
    if (split_by == "None") {
        pdf(paste0(plots_directory, "/", datatype, "/", feature, "_", name, ".pdf"))
        print(VlnPlot(seurat_object, features = feature, assay = "scenic", slot = "scale.data",
            pt.size = 0.25) +
                labs(y = "AUCell score") +
              theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 0, hjust = 0.5)) +
              NoLegend())
    } else {
        pdf(paste0(plots_directory, "/", datatype, "/", feature, "_", split_by, "_", name, ".pdf"))
        print(VlnPlot(seurat_object, features = feature, split.by = split_by, assay = "scenic", slot = "scale.data",
        pt.size = 0.25) +
            labs(y = "AUCell score") +
            theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 0, hjust = 0.5)))
    }
    dev.off()
}

for (regulon in rownames(aucell_matrix)) {
    plot_violin_aucell(seurat_object, regulon, params$cell_type, name = "aucell_score_violin_cluster")
}

if (params$condition != "None") {
    plot_violin_aucell(seurat_object, regulon, params$cell_type, params$condition, name = "aucell_score_split_violin")
    plot_violin_aucell(seurat_object, regulon, params$condition, name = "aucell_score_violin_condition")
}
```

#### Top 10 regulons across all conditions or cell types

```{r Top10_regulons}
# Select top 10 regulons by z-score and generate a violin plot with regulon on x axis and AUCell score on y axis and split by condition or cell type
if (params$condition != "None") {
    top10_regulons_condition <- aucell_zscore_condition %>%
        arrange(desc(annotation_zscore)) %>%
        slice_head(n = 10)
}

top10_regulons_celltype <- aucell_zscore_celltype %>%
    arrange(desc(annotation_zscore)) %>%
    slice_head(n = 10)

source(params$stacked_vln_function)

if (params$condition != "None") {
    pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_", params$condition, "_stacked_violin.pdf"), width = 7, height = 10)
    Idents(seurat_object) <- params$condition
    print(StackedVlnPlot(obj = seurat_object, features = top10_regulons_condition$regulon, assay = "scenic", slot = "scale.data") +
              plot_annotation(title = "Top 10 regulons condition", theme = theme(plot.title = element_text(size = 14, hjust = 0.5))))

    Idents(seurat_object) <- params$cell_type
    print(StackedVlnPlot(obj = seurat_object, features = top10_regulons_condition$regulon, assay = "scenic", slot = "scale.data") +
              plot_annotation(title = "Top 10 regulons condition", theme = theme(plot.title = element_text(size = 14, hjust = 0.5))))
    dev.off()
}

pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_", params$cell_type, "_stacked_violin.pdf"), width = 7, height = 10)
Idents(seurat_object) <- params$cell_type
StackedVlnPlot(obj = seurat_object, features = top10_regulons_celltype$regulon, assay = "scenic", slot = "scale.data") +
    plot_annotation(title = "Top 10 regulons celltype", theme = theme(plot.title = element_text(size = 14, hjust = 0.5)))

if (params$condition != "None") {
    Idents(seurat_object) <- params$condition
    StackedVlnPlot(obj = seurat_object, features = top10_regulons_celltype$regulon, assay = "scenic", slot = "scale.data") +
        plot_annotation(title = "Top 10 regulons celltype", theme = theme(plot.title = element_text(size = 14, hjust = 0.5)))
}
dev.off()
```

#### Top 10 regulons per group based on AUCell z-score

```{r Top10_regulons_per_group}
# Select top 10 regulons per condition or per cell type based on z-score
top10_regulons_per_group <- function(aucell_zscore_table, groups) {
    regulon_list <- list()
    for (group in groups) {
        top10_regulons_per_group <- aucell_zscore_table %>%
            filter(annotation == group) %>%
            arrange(desc(annotation_zscore)) %>%
            slice_head(n = 10)
        top10_regulons_per_group$group <- as.character(group)
        regulon_list[[as.character(group)]] <- top10_regulons_per_group
    }
    return(regulon_list)
}

if (params$condition != "None") {
    top10_regulons_per_condition <- top10_regulons_per_group(aucell_zscore_table = aucell_zscore_condition,
                                                         groups = unique(seurat_object@meta.data[[params$condition]]))
}

top10_regulons_per_celltype <- top10_regulons_per_group(aucell_zscore_table = aucell_zscore_celltype,
                                                         groups = unique(seurat_object@meta.data[[params$cell_type]]))

# Plot
if (params$condition != "None") {
    pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$condition, "_z-score", "_stacked_violin.pdf"), width = 7, height = 10)
    Idents(seurat_object) <- params$condition
    i <- 1
    for (group in top10_regulons_per_condition) {
        group_name <- names(top10_regulons_per_condition)[i]
        print(StackedVlnPlot(seurat_object, features = group[["regulon"]], assay = "scenic", slot = "scale.data") +
              plot_annotation(title = group_name, theme = theme(plot.title = element_text(size = 14, hjust = 0.5))))
    i <- i + 1
}
dev.off()
}

pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$cell_type, "_z-score", "_stacked_violin.pdf"), width = 7, height = 10)
Idents(seurat_object) <- params$cell_type
i <- 1
for (group in top10_regulons_per_celltype) {
    group_name <- names(top10_regulons_per_celltype)[i]
    print(StackedVlnPlot(seurat_object, features = group[["regulon"]], assay = "scenic", slot = "scale.data") +
              plot_annotation(title = group_name, theme = theme(plot.title = element_text(size = 14, hjust = 0.5))))
    i <- i + 1
}
dev.off()
```

```{r Heatmap_condition}
if (params$condition != "None") {
    # Plot heatmap of AUCell z-scores showing the top 10 regulons per condition or cell type
    top10_regulons_per_condition <- bind_rows(top10_regulons_per_condition)
    top10_regulons_per_condition_aucell <- aucell_zscore[top10_regulons_per_condition$regulon, ]

    # Set anything above 3 to 3, and anything below -3 to -3
    top10_regulons_per_condition_aucell <- apply(top10_regulons_per_condition_aucell, MARGIN = 1,
                                                 FUN = function(x) ifelse(x > 3, 3, x))
    top10_regulons_per_condition_aucell <- apply(top10_regulons_per_condition_aucell, MARGIN = 1,
                                                 FUN = function(x) ifelse(x < -3, -3, x))

    annotation_col <- metadata %>%
        select(barcode, !!sym(params$condition)) %>%
        column_to_rownames(var = "barcode")

    pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$condition, "_z-score", "_heatmap.pdf"), width = 8, height = 6)
    print(pheatmap(top10_regulons_per_condition_aucell, show_colnames = FALSE,
                   annotation_col = annotation_col))
    dev.off()
}
```

```{r Heatmap_celltype}
# Plot heatmap of AUCell z-scores showing the top 10 regulons per condition or cell type
top10_regulons_per_celltype <- bind_rows(top10_regulons_per_celltype)
top10_regulons_per_celltype_aucell <- aucell_zscore[top10_regulons_per_celltype$regulon, ]

# Set anything above 3 to 3, and anything below -3 to -3
top10_regulons_per_celltype_aucell <- apply(top10_regulons_per_celltype_aucell, MARGIN = 1,
                                            FUN = function(x) ifelse(x > 3, 3, x))
top10_regulons_per_celltype_aucell <- apply(top10_regulons_per_celltype_aucell, MARGIN = 1,
                                            FUN = function(x) ifelse(x < -3, -3, x))

annotation_col <- metadata %>%
    select(barcode, !!sym(params$cell_type)) %>%
    column_to_rownames(var = "barcode")

pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$cell_type, "_z-score", "_heatmap.pdf"), width = 8, height = 10)
pheatmap(top10_regulons_per_celltype_aucell, show_colnames = FALSE,
         annotation_col = annotation_col)
dev.off()
```

#### Top 10 regulons per group based on absolute AUCell score

```{r Top10_regulons_per_group_abs}
top10_regulons_per_group_abs <- function(aucell_matrix, metadata, group) {
    aucell_top <- aucell_matrix %>%
        rownames_to_column(var = "regulon") %>%
        pivot_longer(-regulon, names_to = "barcode", values_to = "aucell_score") %>%
        left_join(metadata %>% select(barcode, !!sym(group))) %>%
        group_by(regulon, !!sym(group)) %>%
        summarise(mean_aucell_score = mean(aucell_score), .groups = "drop_last") %>%
        arrange(desc(mean_aucell_score)) %>%
        group_by(!!sym(group)) %>%
        slice_head(n = 10) %>%
        ungroup()
    return(aucell_top)
}

try({top10_regulons_per_condition_abs <- top10_regulons_per_group_abs(aucell_matrix, metadata, group = params$condition)}, silent = TRUE)
top10_regulons_per_celltype_abs <- top10_regulons_per_group_abs(aucell_matrix, metadata, group = params$cell_type)
```

```{r Heatmap_condition_abs}
if (params$condition != "None") {
    top10_regulons_per_condition_abs_aucell <- aucell_zscore[top10_regulons_per_condition_abs$regulon, ]

    # Set anything above 3 to 3, and anything below -3 to -3
    top10_regulons_per_condition_abs_aucell <- apply(top10_regulons_per_condition_abs_aucell, MARGIN = 1,
                                                     FUN = function(x) ifelse(x > 3, 3, x))
    top10_regulons_per_condition_abs_aucell <- apply(top10_regulons_per_condition_abs_aucell, MARGIN = 1,
                                                     FUN = function(x) ifelse(x < -3, -3, x))

    annotation_col <- metadata %>%
        select(barcode, !!sym(params$condition)) %>%
        column_to_rownames(var = "barcode")


    pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$condition, "_abs", "_heatmap.pdf"), width = 8, height = 6)
    print(pheatmap(top10_regulons_per_condition_abs_aucell, show_colnames = FALSE,
                   annotation_col = annotation_col))
    dev.off()
}
```

```{r Heatmap_celltype_abs}
top10_regulons_per_celltype_abs_aucell <- aucell_zscore[top10_regulons_per_celltype_abs$regulon, ]

# Set anything above 3 to 3, and anything below -3 to -3
top10_regulons_per_celltype_abs_aucell <- apply(top10_regulons_per_celltype_abs_aucell, MARGIN = 1,
                                                FUN = function(x) ifelse(x > 3, 3, x))
top10_regulons_per_celltype_abs_aucell <- apply(top10_regulons_per_celltype_abs_aucell, MARGIN = 1,
                                                FUN = function(x) ifelse(x < -3, -3, x))

annotation_col <- metadata %>%
    select(barcode, !!sym(params$cell_type)) %>%
    column_to_rownames(var = "barcode")

pdf(paste0(params$plots_directory, "/", datatype, "/top10_regulons_per_", params$cell_type, "_abs", "_heatmap.pdf"), width = 8, height = 10)
pheatmap(top10_regulons_per_celltype_abs_aucell, show_colnames = FALSE,
         annotation_col = annotation_col)
dev.off()
```

#### Wilcoxon and KS test to identify regulons that are differentially-expressed between conditions or cell types

```{r Stats_test_functions}
if (params$condition != "None") {
    aucell_matrix_long <- aucell_matrix %>%
        rownames_to_column(var = "regulon") %>%
        pivot_longer(-regulon, names_to = "barcode", values_to = "aucell_score") %>%
        left_join(metadata %>% select(barcode, !!sym(params$condition), !!sym(params$cell_type)))
} else {
    aucell_matrix_long <- aucell_matrix %>%
        rownames_to_column(var = "regulon") %>%
        pivot_longer(-regulon, names_to = "barcode", values_to = "aucell_score") %>%
        left_join(metadata %>% select(barcode, !!sym(params$cell_type)))
}

# Condition comparisons
if (params$condition != "None") {
    condition_comparisons <- function(reference, test) {
        comparison_dataframe <- data.frame(reference = NA, test = NA)
        i <- 1
        for (condition in test) {
            comparison_dataframe[i, "reference"] <- reference
            comparison_dataframe[i, "test"] <- condition
            i <- i + 1
        }
        return(comparison_dataframe)
    }

    condition_comparisons <- condition_comparisons(reference = params$reference_condition,
                                               test = setdiff(unique(aucell_matrix_long[[params$condition]]), params$reference_condition))
}

# Cell type comparisons
celltype_comparisons <- function(celltype = params$cell_type, metadata) {
    comparison_dataframe <- data.frame(reference = NA, test = NA)
    class(comparison_dataframe$test) <- "list"
    for (i in 1:length(unique(metadata[[celltype]]))) {
        comparison_dataframe[i, 2] <- unique(metadata[[celltype]])[i]
        comparison_dataframe[i, 1] <- paste(setdiff(unique(metadata[[celltype]]), unique(metadata[[celltype]])[i]), collapse = ",")
    }
    return(comparison_dataframe)
}

celltype_comparisons <- celltype_comparisons(params$cell_type, metadata)

# Test functions - Wilcoxon and KS test
# Comparison of single regulon
single_regulon_comparison <- function(comparisons, regulon_name, group, stats_test) {
    # test can be wilcoxon or KS
    results <- data.frame(regulon = NA, reference = NA, test = NA,
                          pvalue = NA, statistic = NA, log2FC = NA)

    for (i in 1:nrow(comparisons)) {
        reference_values <- aucell_matrix_long %>%
            filter(regulon == regulon_name) %>%
            filter((!!sym(group)) %in% unlist(strsplit(comparisons[i, 1][[1]], split = ","))) %>%
            pull(aucell_score)

        test_values <- aucell_matrix_long %>%
            filter(regulon == regulon_name) %>%
            filter((!!sym(group)) %in% unlist(strsplit(comparisons[i, 2][[1]], split = ","))) %>%
            pull(aucell_score)

        log2FC <- log2(mean(test_values)/mean(reference_values))

        if (stats_test == "wilcoxon") {
            test_results <- wilcox.test(reference_values, test_values)
        } else if (stats_test == "KS") {
            test_results <- ks.test(reference_values, test_values)
        }

        results[i, 1] <- regulon_name
        results[i, 2] <- comparisons[i, 1]
        results[i, 3] <- comparisons[i, 2]
        results[i, 4] <- test_results$p.value
        results[i, 5] <- test_results$statistic
        results[i, 6] <- log2FC
    }
    return(results)
}

# Combined analysis of multiple regulons
all_regulons_comparison <- function(comparisons, aucell_matrix_long, group, stats_test) {
    results_all <- data.frame(regulon = character(), reference = character(), test = character(),
                              pvalue = numeric(), statistic = numeric(), log2FC = numeric())
    for (regulon_name in unique(aucell_matrix_long$regulon)) {
        regulon_results <- single_regulon_comparison(comparisons, regulon_name, group, stats_test)
        results_all <- rbind(results_all, regulon_results)
    }
    return(results_all)
}
```

```{r Wilcoxon}
try({wilcoxon_results_condition <- all_regulons_comparison(condition_comparisons, aucell_matrix_long, params$condition, "wilcoxon")
wilcoxon_results_condition$FDR <- p.adjust(wilcoxon_results_condition$pvalue, method = "BH")
write_csv(wilcoxon_results_condition[, c(1:4, 7, 5, 6)], paste0(results_directory, "/", datatype, "/", "wilcoxon_condition_comparison.csv"))}, silent = TRUE)

wilcoxon_results_celltype <- all_regulons_comparison(celltype_comparisons, aucell_matrix_long, params$cell_type, "wilcoxon")
wilcoxon_results_celltype$FDR <- p.adjust(wilcoxon_results_celltype$pvalue, method = "BH")
write_csv(wilcoxon_results_celltype[, c(1:4, 7, 5, 6)], paste0(results_directory, "/", datatype, "/", "wilcoxon_celltype_comparison.csv"))
```

```{r Wilcoxon_FindMarkers}
# Cell type
Idents(seurat_object) <- params$cell_type
wilcoxon_markers_list <- list()
for (identity in as.character(unique(Idents(seurat_object)))) {
    markers <- FindMarkers(seurat_object, slot = "scale.data", ident.1 = identity, verbose = FALSE)
    markers$test_cell_type <- identity
    markers <- rownames_to_column(markers, var = "regulon")
    wilcoxon_markers_list[[identity]] <- markers
}
wilcoxon_markers_celltype <- bind_rows(wilcoxon_markers_list)
write_csv(wilcoxon_markers_celltype, paste0(results_directory, "/", datatype, "/", "wilcoxon_cluster_comparison_FindMarkers.csv"))

# Condition - test vs. reference
if (params$condition != "None") {
    Idents(seurat_object) <- params$condition
    test_identities <- setdiff(as.character(unique(Idents(seurat_object))), params$reference_condition)
    wilcoxon_markers_list <- list()
    for (identity in test_identities) {
        markers <- FindMarkers(seurat_object, slot = "scale.data", ident.1 = identity, ident.2 = params$reference_condition, verbose = FALSE)
        markers$test_condition <- identity
        markers <- rownames_to_column(markers, var = "regulon")
        wilcoxon_markers_list[[identity]] <- markers
    }
    wilcoxon_markers_condition_reference <- bind_rows(wilcoxon_markers_list)
    write_csv(wilcoxon_markers_condition_reference, paste0(results_directory, "/", datatype, "/", "wilcoxon_condition_reference_comparison_FindMarkers.csv"))
}

# Condition - one vs. all
if (params$condition != "None") {
    Idents(seurat_object) <- params$condition
    wilcoxon_markers_list <- list()
    for (identity in as.character(unique(Idents(seurat_object)))) {
        markers <- FindMarkers(seurat_object, slot = "scale.data", ident.1 = identity, verbose = FALSE)
        markers$test_condition <- identity
        markers <- rownames_to_column(markers, var = "regulon")
        wilcoxon_markers_list[[identity]] <- markers
    }
    wilcoxon_markers_condition <- bind_rows(wilcoxon_markers_list)
    write_csv(wilcoxon_markers_condition, paste0(results_directory, "/", datatype, "/", "wilcoxon_condition_comparison_FindMarkers.csv"))
}
```

```{r KS_test, message = FALSE, warning = FALSE}
try({ks_results_condition <- all_regulons_comparison(condition_comparisons, aucell_matrix_long, params$condition, "KS")
ks_results_condition$FDR <- p.adjust(ks_results_condition$pvalue, method = "BH")
write_csv(ks_results_condition[, c(1:4, 7, 5, 6)], paste0(results_directory, "/", datatype, "/", "ks_condition_comparison.csv"))}, silent = TRUE)

ks_results_celltype <- all_regulons_comparison(celltype_comparisons, aucell_matrix_long, params$cell_type, "KS")
ks_results_celltype$FDR <- p.adjust(ks_results_celltype$pvalue, method = "BH")
write_csv(ks_results_celltype[, c(1:4, 7, 5, 6)], paste0(results_directory, "/", datatype, "/", "ks_celltype_comparison.csv"))
```

#### Heatmap of top 10 regulons per group based on Wilcoxon results

```{r Top10_wilcoxon_KS}
# Using Wilcoxon output from the FindMarkers function so there is some pre-filtering
top10_wilcoxon_celltype <- wilcoxon_markers_celltype %>%
    group_by(test_cell_type) %>%
    filter(p_val_adj < params$FDR_threshold) %>%
    arrange(desc(avg_diff)) %>%
    slice_head(n = 10) %>%
    ungroup()
write_csv(top10_wilcoxon_celltype, paste0(results_directory, "/", datatype, "/", "wilcoxon_celltype_top10.csv"))

# The KS test has no pre-filtering
top10_ks_celltype <- ks_results_celltype %>%
    group_by(test) %>%
    filter(FDR < params$FDR_threshold) %>%
    arrange(desc(log2FC)) %>%
    slice_head(n = 10) %>%
    ungroup()
write_csv(top10_ks_celltype, paste0(results_directory, "/", datatype, "/", "ks_celltype_top10.csv"))

if (params$condition != "None") {
    top10_wilcoxon_condition_reference <- wilcoxon_markers_condition_reference %>%
        group_by(test_condition) %>%
        filter(p_val_adj < params$FDR_threshold) %>%
        arrange(desc(avg_diff)) %>%
        slice_head(n = 10) %>%
        ungroup()
    write_csv(top10_wilcoxon_condition_reference, paste0(results_directory, "/", datatype, "/", "wilcoxon_condition_top10.csv"))

     top10_ks_condition <- ks_results_condition %>%
        group_by(test) %>%
        filter(FDR < params$FDR_threshold) %>%
        arrange(desc(log2FC)) %>%
        slice_head(n = 10) %>%
        ungroup()
    write_csv(top10_ks_condition, paste0(results_directory, "/", datatype, "/", "ks_condition_top10.csv"))
}
```

```{r Heatmap_wilcoxon}
top10_heatmap <- function(top10_regulons_table, aucell_zscore, group) {
    aucell_zscore <- rownames_to_column(as.data.frame(aucell_zscore), var = "regulon")
    top10_regulons_table <- aucell_zscore %>%
        filter(regulon %in% top10_regulons_table$regulon) %>%
        column_to_rownames(var = "regulon")

    # Set anything above 3 to 3, and anything below -3 to -3
    top10_regulons_table <- apply(top10_regulons_table, MARGIN = 1,
                                  FUN = function(x) ifelse(x > 3, 3, x))
    top10_regulons_table <- apply(top10_regulons_table, MARGIN = 1,
                                  FUN = function(x) ifelse(x < -3, -3, x))

    annotation_col <- metadata %>%
        select(barcode, !!sym(group)) %>%
        column_to_rownames(var = "barcode")

    print(pheatmap(top10_regulons_table, show_colnames = FALSE,
                   annotation_col = annotation_col, filename = paste0(params$plots_directory, "/", datatype, "/top10_regulons_wilcoxon_", group, "_heatmap.pdf"), width = 8, height = 10))
}

top10_heatmap(top10_wilcoxon_celltype, aucell_zscore, params$cell_type)

if (params$condition != "None") {
    top10_heatmap(top10_wilcoxon_condition_reference, aucell_zscore, params$condition)
}
```

#### Top 10 regulons per group - average expression per cluster or per condition

```{r Heatmap_wilcoxon_average}
Idents(seurat_object) <- params$cell_type
top10_wilcoxon_celltype_average <- AverageExpression(seurat_object, features = unique( top10_wilcoxon_celltype$regulon), assays = "scenic", slot = "scale.data")
top10_wilcoxon_celltype_average <- top10_wilcoxon_celltype_average[["scenic"]]
pheatmap(top10_wilcoxon_celltype_average, scale = "row",
         filename = paste0(params$plots_directory, "/", datatype, "/top10_regulons_wilcoxon_", params$cell_type, "_average_heatmap.pdf"), width = 5, height = 6)

if (params$condition != "None") {
    Idents(seurat_object) <- params$condition
    top10_wilcoxon_condition_reference_average <- AverageExpression(seurat_object, features = unique(top10_wilcoxon_condition_reference$regulon), assays = "scenic", slot = "scale.data")
    top10_wilcoxon_condition_reference_average <- top10_wilcoxon_condition_reference_average[["scenic"]]
    pheatmap(top10_wilcoxon_condition_reference_average, scale = "row",
             filename = paste0(params$plots_directory, "/", datatype, "/top10_regulons_wilcoxon_", params$condition, "_average_heatmap.pdf"), width = 5, height = 6)
}
```

```{r Heatmap_ks_average}
Idents(seurat_object) <- params$cell_type
top10_ks_celltype_average <- AverageExpression(seurat_object, features = unique( top10_ks_celltype$regulon), assays = "scenic", slot = "scale.data")
top10_ks_celltype_average <- top10_ks_celltype_average[["scenic"]]
pheatmap(top10_ks_celltype_average, scale = "row",
         filename = paste0(params$plots_directory, "/", datatype, "/top10_regulons_ks_", params$cell_type, "_average_heatmap.pdf"), width = 5, height = 8,fontsize=6)

if (params$condition != "None") {
    Idents(seurat_object) <- params$condition
    top10_ks_condition_average <- AverageExpression(seurat_object, features = unique( top10_ks_condition$regulon), assays = "scenic", slot = "scale.data")
    top10_ks_condition_average <- top10_ks_condition_average[["scenic"]]
    pheatmap(top10_ks_condition_average, scale = "row",
             filename = paste0(params$plots_directory, "/", datatype, "/top10_regulons_ks_", params$condition, "_average_heatmap.pdf"), width = 5, height = 6)
}
```
