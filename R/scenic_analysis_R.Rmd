---
title: "Scenic analysis in R"
author: "Devika Agarwal"
date: 'Last update: `r date()`'
output:
  html_document:
    theme: cerulean
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: yes
      toc_depth: 6
params:
  working_dir: "/Users/lgarner/Documents/Klenerman_group/2020/Analysis/10x_blood_and_liver_MAIT/pyscenic_test"
  num_workers: 6    # number of cores
  datatype: "normalised"    # raw or normalised
  results_directory: "../pyscenic_results.dir/normalised.dir/all-samples.dir/pyscenic_r.dir"
  plots_directory: "../plots.dir/normalised.dir/all-samples.dir/pyscenic_r.dir"
  celltype: "SCT_snn_res.0.5"    # column name for celltype annotations in files
  condition: "tissue"    # column name for condition annotation in files or "None"
  celltype_condition: "None"    # column name for celltype_condition columns in files or "None"
  zscores_celltype: "../pyscenic_results.dir/normalised.dir/all-samples.dir/aucell_zscores_cluster-annotation.csv"    # Z scores based on AUCell scores for celltypes
  zscores_condition: "../pyscenic_results.dir/normalised.dir/all-samples.dir/aucell_zscores_tissue-annotation.csv"    # Z scores based on AUCell scores for condition or "None"
  zscores_celltype_condition: "None"    # Z scores based on AUCell scores for celltype_condition joint or "None"
  zscore_filter_threshold_celltype: 1.5    # Z score filter threshold for celltype specific scores for heatmap
  zscore_filter_threshold_condition: 1.5    # Z score filter threshold for condition specific scores for heatmap or "None"
  zscore_filter_threshold_celltype_condition: "None"    # Z score filter threshold for celltype + condition specific scores for heatmap or "None"
  binary_mtx: "../pyscenic_results.dir/normalised.dir/all-samples.dir/binary_matrix.csv" # binary AUCell scores for each cell
  annotation_celltype: "../data.dir/all-samples_cluster-annotation.csv"    # csv file with cellid & celltype annotations for each cell
  annotation_condition: "../data.dir/all-samples_tissue-annotation.csv"    # csv file with cellid & condition annotation for each cell or "None"
  annotation_celltype_condition: "None"    # csv file with cellid & celltype_condition annotation for each cell or "None"
  binary_heatmap_cell_annotations : "../data.dir/all-samples_cluster-annotation.csv" # csv file with cellid and annotation data per cell for binary all cells heatmap or "None"
  rss_celltype: "../pyscenic_results.dir/normalised.dir/all-samples.dir/cluster-annotation_RSS.csv"    # RSS scores per regulon for celltype
  rss_condition: "../pyscenic_results.dir/normalised.dir/all-samples.dir/tissue-annotation_RSS.csv"    # RSS scores per regulon for condition or "None"
  rss_celltype_condition: "None"    # RSS scores per regulon for celltype_condition or "None"
  species: "human"    # fly, human, mouse or None
  regulon_genes: "../pyscenic_results.dir/normalised.dir/all-samples.dir/regulons.csv"    # regulon files generatated from pipeline_pyscenic.py or "None"
  exp_matrix: "../pyscenic_results.dir/normalised.dir/all-samples.dir/filtered-expression.csv"    # filtered-raw-expression.csv exp matrix generated in step 1 of pipeline_pyscenic.py for background for pathway analysis or "None"
  go_ont_option: "BP"    # "BP", "MF", "CC" or "ALL" for all three. Default is "MF" in ClusterProfiler
  wilcoxon_celltype_top: "wilcoxon_celltype_top10.csv"    # or "None"
  wilcoxon_condition_top: "wilcoxon_condition_reference_top10.csv"   # or "None", results from comparison to reference condition
  ks_celltype_top: "ks_celltype_top10.csv"    # or "None"
  ks_condition_top: "ks_condition_top10.csv"    # or "None"
  pvaluecutoff: 0.05    # Pathway enrichment p-value cutoff
  qvaluecutoff: 0.05    # Pathway enrichment q-value cutoff
  maxGSSize: 1000    # Pathway enrichment maximum gneset size
  msigdb_geneset: "C2"    # geneset category for MSigDB, can be C1: positional gene sets, C2: curated gene sets, C3: motif gene sets, C4: computational gene sets, C5: GO gene sets, C6: oncogenic signatures, C7: immunologic signatures, H: hallmark gene sets
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 18px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 16px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 16px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 14px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      root.dir = params$working_dir)
# Use the following code to render the document by using objects from the global environment:
# rmarkdown::render("Markdown_code/3a_Thirst2_doublet_identification.Rmd")
```

```{r packages_etc, eval = T}
library(ggplot2)
library(Matrix)
library(cowplot)
library(Seurat)
library(plyr)
library(tidyverse)
library(future)
library(foreach)
library(doMC)
library(uwot)
library(pheatmap)
library(RColorBrewer)
library(tidyr)
library(pheatmap)
library(grid)
library(data.table)
library(ggrepel)
library(readr)
library(clusterProfiler)
library(ReactomePA)
library(foreach)
library(msigdbr)
library(org.Mm.eg.db)
library(org.Hs.eg.db)
library(ggforce)
try({library(org.Dm.eg.db)}, silent = TRUE)

registerDoMC(cores = params$num_workers)
theme_set(theme_bw())
```

```{r create_dirs}
results_directory <- params$results_directory
plots_directory <- params$plots_directory
working_dir <- params$working_dir
datatype <- params$datatype

if (!dir.exists(plots_directory)) {
    dir.create(plots_directory, recursive = TRUE)
}

if (!dir.exists(results_directory)) {
    dir.create(results_directory, recursive = TRUE)
}
```

```{r functions}
rss_plot <- list(
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_text(size = 8),
        strip.background = element_blank(),
        panel.background = element_rect(fil = "white"),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(size = 8),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 6)))

save_pheatmap_pdf <- function(x, filename, width = 7,height = 7) {
  stopifnot(!missing(x))
  stopifnot(!missing(filename))
  pdf(filename, width = width, height = height)
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}

zscore_heatmap <- function(zscores_df, annotation_type = params$celltype,
                           filter_threshold = 3, plot_height = 6, plot_width = 8,
                           units = "in") {
  if (max(zscores_df$annotation_zscore) >= as.numeric(filter_threshold)) {
    zscores_specific <- zscores_df %>%
      dplyr::filter((annotation_zscore) >= as.numeric(filter_threshold))

    zscores_specific_wide <- zscores_specific %>%
      dplyr::select(regulon, annotation,annotation_zscore) %>%
      tidyr::pivot_wider(names_from = annotation, values_from = annotation_zscore)
    zscores_specific_wide <- zscores_specific_wide %>%
      column_to_rownames(var = "regulon")
    zscores_specific_wide <- as.matrix(zscores_specific_wide)

    mat2 <- as.data.frame(zscores_specific_wide)
    mat2 <- mat2 %>%
      mutate_if(is.numeric, round, digits = 1)
    mat2[is.na(mat2)] <- ""
    annotation_type <- as.character(annotation_type)

      if (ncol(zscores_specific_wide) >= 2) {
        plot_1 <- pheatmap(
          mat = (t(zscores_specific_wide)),
          color = colorRampPalette((brewer.pal(n = 8, name = "YlGnBu")))(100),
          cluster_cols = F, cluster_rows = F, na_col = "white",
          display_numbers = as.matrix(t(mat2)), number_format = "%.1f",
          fontsize_row = 8, legend = T, number_color = "black",
          fontsize = 8, fontsize_col = 8,
          main = paste0(annotation_type,' specific TF regulators - Z score'))

        save_pheatmap_pdf(
          plot_1,
          filename = paste0(plots_directory, '/', annotation_type,
                            '_specific_zscore_', filter_threshold, '_heatmap.pdf'),
          width = plot_width, height = plot_height)

        saveRDS(
          plot_1,
          file = paste0(plots_directory, '/', annotation_type, '_specific_zscore_',
                        filter_threshold, '_heatmap.rds'))
        print(plot_1)
      }
    } else {
    print("Annotation Z scores below the filter threshold parameter")
    }
}

binary_celltype_perc_heatmap <- function(cellInfo_f = params$annotation_celltype,
                                         binary_mtx_f = params$binary_mtx, minPerc = 0.85,
                                         annotation_type = "celltype",
                                         plot_height = 7, plot_width = 10, units = "in",
                                         cluster_rows = T, cluster_cols = T) {
  if(annotation_type != "None"){
    cellInfo <- read.csv(cellInfo_f)
    rownames(cellInfo) <- cellInfo$cellid
    cellInfo[, 2] <- as.factor(cellInfo[, 2])

    binary_mtx <- read_csv(file = binary_mtx_f)
    minPerc <- minPerc
    binary_mtx.merge <- merge(binary_mtx, cellInfo, by.x = "X1", by.y = "cellid")

    regulon_activity_binarised_celltype <- binary_mtx.merge %>%
      dplyr::group_by_if(is.factor) %>%
      dplyr::select(-c(X1)) %>%
      summarise_all(.funs = mean) %>% remove_rownames %>%
      tibble::column_to_rownames(var = {{annotation_type}})
    regulon_activity_binarised_celltype <- t(regulon_activity_binarised_celltype)

    binaryActPerc_subset <- regulon_activity_binarised_celltype[which(rowSums(regulon_activity_binarised_celltype > minPerc) > 0), ]

    plot_1 <- pheatmap::pheatmap(
      binaryActPerc_subset, fontsize = 7,
      color = colorRampPalette(c("white","pink","red"))(100),
      breaks = seq(0, 1, length.out = 100),
      treeheight_row = 10, treeheight_col = 10, border_color = NA,
      clustering_method = "ward.D2", cluster_rows = cluster_rows,
      cluster_cols = cluster_cols)

    save_pheatmap_pdf(
      plot_1,
      filename = paste0(plots_directory, '/', annotation_type, '_regulon_active_perc_cells', minPerc, '_heatmap.pdf'),
      width = plot_width, height = plot_height)

    saveRDS(
      plot_1,
      file = paste0(plots_directory, '/', annotation_type, '_regulon_active_perc_cells',
                    minPerc, '_heatmap.rds'))

    print(plot_1)

    } else {
    print("Annotation csv file not provided")
    }
}

binary_auc_heatmap <- function(binary_mtx_f = params$binary_mtx,
                               annotation_col_f = params$binary_heatmap_cell_annotations,
                               plot_height = 9, plot_width = 12) {
  binary_mtx <- read_csv(file = binary_mtx_f)
  binary_mtx <- binary_mtx %>%
    tibble::column_to_rownames(var = "X1")

  annotation_col <- read.csv(file = annotation_col_f)
  annotation_col <- annotation_col %>%
    column_to_rownames(var="cellid")

  plot_1 <- pheatmap::pheatmap(
    (t(binary_mtx)), fontsize = 6,
    color = colorRampPalette((brewer.pal(n = 9, name = "Greys")))(10),
    treeheight_row = 10, treeheight_col = 10, border_color = NA,
    clustering_method = "ward.D2", show_rownames = T, fontsize_row = 8,
    scale = "none", show_colnames = F, annotation_col = annotation_col, legend = F)

  save_pheatmap_pdf(
    plot_1,
    filename = paste0(plots_directory, "/binary_regulon_activity_allcells_heatmap.pdf"),
    width = plot_width, height = plot_height)

  saveRDS(
    plot_1,
    file = paste0(plots_directory, "/binary_regulon_activity_allcells_heatmap.rds"))
  print(plot_1)
}

RSS_annotation_plot <- function(annotation_type = params$celltype,
                                rss_f = params$rss_celltype, units = "in",
                                plot_height = 5, plot_width = 7) {
  if (annotation_type != "None") {
    rss_scores <- read_csv(file = rss_f)
    annotation_type <- as.character(annotation_type)
    colnames(rss_scores)[1] <- "annotation"

    rss_scores_long <- rss_scores %>%
      tidyr:: pivot_longer(-1, names_to = "Regulon", values_to = "RSS") %>%
      mutate(across(where(is_character), as_factor)) %>%
      group_by(annotation) %>%
      dplyr::arrange(desc(RSS), .by_group = T) %>%
      mutate(order = row_number())
    rss_scores_long$ID <- paste0(rss_scores_long$annotation, "_",
                                 rss_scores_long$Regulon)

    rss_scores_long_2 <- rss_scores %>%
      tidyr:: pivot_longer(-1, names_to = "Regulon", values_to = "RSS") %>%
      mutate(across(where(is_character), as_factor)) %>%
      group_by(annotation) %>%
      dplyr::arrange(desc(RSS), .by_group = T) %>%
      mutate(order = row_number()) %>%
      dplyr::slice(1:5)
    rss_scores_long_2$label <- rss_scores_long_2$Regulon
    rss_scores_long_2$ID <- paste0(rss_scores_long_2$annotation,
                                   "_", rss_scores_long_2$Regulon)
    rss_scores_long_2 <- rss_scores_long_2 %>%
      dplyr::select(annotation, ID, label)

    rss_scores_long_final <- merge(rss_scores_long, rss_scores_long_2,
                                   by = "ID", all.x = T)

    plot_1 <- rss_scores_long_final %>%
      ggplot(aes(x = order, y = RSS, group = annotation.x)) +
      geom_point(colour = "steelblue")
    plot_1 <- plot_1 +
      geom_text_repel(aes(label = label), check_overlap = T, size = 2.5) +
      facet_wrap(~annotation.x, scales = "free") +
      xlab("Regulon")
    plot_1 <- plot_1 +
      rss_plot
    plot_1

    ggsave(
      plot = plot_1,
      filename = paste0("top_", annotation_type, "_specific_RSS_plot.pdf"),
      path = paste0(plots_directory, "/"), dpi = 300,
      units = units, height = plot_height, width = plot_width)

    saveRDS(
      plot_1,
      file = paste0(plots_directory, "/top_", annotation_type, "_specific_RSS_plot.rds"))
    print(plot_1)

    } else {
    print("No annotation type name string or annotation specific RSS score file provided as input")
    }
}

num_active_regulons_annotation <- function(cellInfo_f = params$annotation_celltype,
                                           binary_mtx_f = params$binary_mtx,
                                           annotation_type = params$celltype,
                                           units = "in", plot_height = 3,
                                           plot_width = 9) {
  if (annotation_type != "None") {
    cellInfo <- read.csv(cellInfo_f)
    rownames(cellInfo) <- cellInfo$cellid
    cellInfo[, 2] <- as.factor(cellInfo[, 2])
    binary_mtx <- read_csv(file = binary_mtx_f)
    annotation_type <- as.character(annotation_type)
    binary_mtx.merge <- merge(binary_mtx,cellInfo, by.x = "X1", by.y = "cellid")

    active_cells_per_regulon <- binary_mtx.merge %>%
      dplyr::group_by_if(is.factor) %>%
      dplyr::select(-c(X1)) %>%
      summarise_all(.funs = sum)

    active_cells_per_regulon_long <- active_cells_per_regulon %>%
      pivot_longer(-annotation_type, names_to = "Regulon", values_to = "N_active_cells")

    nRegulons_per_annotation <- active_cells_per_regulon_long %>%
      dplyr::group_by(across(1)) %>%
      summarise(count = sum(N_active_cells > 0)) %>%
      arrange(desc(count))
    colnames(nRegulons_per_annotation)[1] <- "annotation"
    n_annotation_active_per_regulon <- active_cells_per_regulon_long %>%
      group_by(across(2)) %>%
      summarise(count = sum(N_active_cells > 0))

    p1 <-  ggplot(data = nRegulons_per_annotation,
                  aes(x = reorder(annotation, -count), y = count)) +
      geom_bar(stat = "identity", fill = "steelblue") +
      xlab(annotation_type) +
      ylab(paste0("Number of active Regulons per ", annotation_type)) +
      ggtitle(paste0("Number of active regulons per ", annotation_type)) +
      barplot_theme
    p1

    ggsave(
      plot = p1,
      filename = paste0("barplot_active_regulons_per_",
                        annotation_type, ".pdf"),
      path = paste0(plots_directory, "/"),
      dpi = 300, units = units, height = plot_height, width = plot_width)

    saveRDS(
      p1,
      file = paste0(plots_directory, "/barplot_active_regulons_per_",
                    annotation_type, ".rds"))
    print(p1)

    } else {
      print("Cell type annotation files not provided")
  }
}

num_annotation_per_regulon <- function(cellInfo_f = params$annotation_celltype,
                                       binary_mtx_f = params$binary_mtx,
                                       annotation_type = params$celltype,
                                       units = "in", plot_height = 3,
                                       plot_width = 9) {
  if (annotation_type != "None") {
    cellInfo <- read.csv(cellInfo_f)
    rownames(cellInfo) <- cellInfo$cellid
    cellInfo[, 2] <- as.factor(cellInfo[, 2])
    binary_mtx <- read_csv(file = binary_mtx_f)
    annotation_type <- as.character(annotation_type)
    binary_mtx.merge <- merge(binary_mtx, cellInfo, by.x = "X1", by.y = "cellid")

    active_cells_per_regulon <- binary_mtx.merge %>%
      dplyr::group_by_if(is.factor) %>%
      dplyr::select(-c(X1)) %>%
      summarise_all(.funs = sum)

    active_cells_per_regulon_long <- active_cells_per_regulon %>%
      pivot_longer(-annotation_type, names_to = "Regulon", values_to = "N_active_cells")

    n_annotation_active_per_regulon <- active_cells_per_regulon_long %>%
      group_by(across(2)) %>%
      summarise(count = sum(N_active_cells > 0))

    p2 <- ggplot(data = n_annotation_active_per_regulon,
                 aes(x = reorder(Regulon,-count), y = count)) +
      geom_bar(stat = "identity", fill = "steelblue") +
      xlab("Regulons") +
      ylab(paste0("Number of ", annotation_type, " active per regulon")) + ggtitle(paste0("Number of ", annotation_type, " active per regulon")) +
      barplot_theme
    p2

    ggsave(
      plot = p2,
      filename = paste0("barplot_number_of", annotation_type, "active_per_regulon.pdf"),
      path = paste0(plots_directory, "/"), dpi = 300,
      units = units, height = plot_height, width = plot_width)
    saveRDS(p2, file = paste0(plots_directory, "/barplot_number_of",
                              annotation_type, "active_per_regulon.rds"))
    print(p2)

    } else {
    print("Cell type annotation files not provided")
    }
}

barplot_theme <- list(theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                                       vjust = 1, size = 5),
                            axis.title = element_text(size = 6),
                            plot.title = element_text(size = 7)))

regulon_pathway_enrichment <- function(regulons_f = params$regulon_gene,
                                       ont_option = params$go_ont_option,
                                       maxGSSize = params$maxGSSize,
                                       pvalueCutoff = as.numeric(params$pvaluecutoff),
                                       qvalueCutoff = as.numeric(params$qvaluecutoff),
                                       pathway_db ="enrichGO") {
  regulon_genes <- read_csv(file = regulons_f)
  regulon_genes$genes <- gsub("[[:space:]]", "", regulon_genes$genes)    # note
  regulon_genes$genes_list <- (strsplit(regulon_genes$genes, ","))
  genes_list <- (regulon_genes$genes_list)
  names(genes_list) <- regulon_genes$regulon_name

  background <- read_csv(file = params$exp_matrix)
  universe <- as.character(background$X1)
  rm(background)

  if (params$species == "fly") {
    res <- compareCluster(geneClusters = genes_list,
                          universe = universe, pAdjustMethod = "BH",
                          pvalueCutoff = pvalueCutoff, qvalueCutoff = qvalueCutoff,
                          maxGSSize = maxGSSize, keyType = "SYMBOL", OrgDb = org.Dm.eg.db,
                          readable = F, ont = ont_option , fun = "enrichGO")

    if (pathway_db == "enrichGO") {
      res_simplify <- clusterProfiler::simplify(x = res, cutoff = 0.7)
      saveRDS(
        res_simplify,
        file = paste0(results_directory, "/", pathway_db,
                      "_simplified_regulons_results.rds"))
      return(res_simplify)

    } else {
      saveRDS(
        res,
        file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
      return(res)
    }

  } else if(params$species == "human") {
    res <- compareCluster(geneClusters = genes_list,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          keyType = "SYMBOL", OrgDb = org.Hs.eg.db, readable = F,
                          ont = ont_option, fun = "enrichGO", universe = universe)

    if (pathway_db == "enrichGO") {
      res_simplify <- clusterProfiler::simplify(x = res, cutoff = 0.7)
      saveRDS(
        res_simplify,
        file = paste0(results_directory, "/", pathway_db, "_simplified_regulons_results.rds"))
      return(res_simplify)

    } else {
       saveRDS(
         res,
         file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
       return(res)
    }

  } else if (params$species == "mouse"){
    res <- compareCluster(geneClusters = genes_list,
                          universe = universe, pAdjustMethod = "BH",
                          pvalueCutoff = pvalueCutoff, qvalueCutoff = qvalueCutoff,
                          maxGSSize = maxGSSize, fun = "enrichGO" )

    if (pathway_db == "enrichGO") {
      res_simplify <- clusterProfiler::simplify(x = res, cutoff = 0.7)
      saveRDS(
        res_simplify,
        file = paste0(results_directory, "/", pathway_db,
                      "_simplified_regulons_results.rds"))
      return(res_simplify)

    } else {
       saveRDS(
         res,file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
       return(res)
    }

  } else if (params$species == "None") {
    print("No species information provided and relevant Organism dbi needs to be loaded from Bioconductor")

  } else {
    print("Current options are fly, human, mouse or None")
  }
}

enrichplot_theme <- list(theme(legend.title = element_text(size = 7),
                               legend.text = element_text(size = 7),
                               strip.background = element_blank(),
                               strip.text = element_text(face = "bold",size = 7),
                               axis.text.y = element_text(size = 7)))

wilcoxon_pathway_plot <- function(wilcoxon_f = params$wilcoxon_celltype_top,
                                  annotation_type = "test_cell_type",
                                  test_type = "one_vs_all",
                                  plot_height = 8, plot_width = 8, units = "in",
                                  showCategory = 8, stat_test = "wilcoxon",
                                  pathwaydb = "GO_term", res_f = GO_res,
                                  plot_row = 1, plot_col = 1) {
  comparecluster_df <- res_f@compareClusterResult

  if (annotation_type != "None") {
     wilcoxon_top10 <- read_csv(file = paste0(results_directory, "/", wilcoxon_f))
     wilcoxon_top10 <- wilcoxon_top10 %>%
       dplyr::select(regulon, !!sym(annotation_type))

     cc_subset <- comparecluster_df %>%
       inner_join(wilcoxon_top10, by = c("Cluster" = "regulon"))

     if (nrow(cc_subset) > 0) {
       gsize <- as.numeric(sub("/\\d+$", "", as.character(cc_subset$GeneRatio)))
       gcsize <- as.numeric(sub("^\\d+/", "", as.character(cc_subset$GeneRatio)))
       cc_subset$GeneRatio <- gsize/gcsize
       cluster <- paste(as.character(cc_subset$Cluster), "(", gcsize, ")", sep = "")
       lv <- unique(cluster)[order(as.numeric(unique(cc_subset$Cluster)))]
       cc_subset$Cluster <- factor(cluster, levels = lv)

       plot_data <- cc_subset %>%
         group_by(Cluster) %>%
         dplyr::arrange(p.adjust) %>%
         dplyr::slice(1:showCategory)
       idx <- order(plot_data$Cluster)
       plot_data$Description <- factor(plot_data$Description,
                                       levels = rev(unique(plot_data$Description[idx])))

       p1 <- ggplot(plot_data,
                    aes_string(x = "Cluster", y = "Description", color = "p.adjust"))
       p1 <- p1 +
         geom_point(aes(size = Count)) +
         theme(axis.text.y = element_text(size = 7),
               axis.text.x = element_text(size=7, angle = 45, hjust = 1)) +
         scale_color_viridis_c(direction = 1, alpha = 0.8) +
         xlab("") +
         ylab("") +
         theme(legend.title = element_text(size = 7),
               legend.text = element_text(size = 7))
       p1 <- p1 +
         facet_wrap_paginate(.~ .data[[annotation_type]], scales = "free", shrink = T,
                             nrow = plot_row, ncol = plot_col, page = 1)
       num_pages <- n_pages(p1)

       pdf(paste0(plots_directory, "/", pathwaydb, "_plot_", stat_test,
                  "_top10", annotation_type, "_", test_type, ".pdf"),
           height = plot_height, width = plot_width)
       for (i in 1:num_pages) {
         print(p1 +
               facet_wrap_paginate(.~ .data[[annotation_type]], scales = "free", shrink = T,
                                   nrow = plot_row, ncol = plot_col, page = i) +
           theme(strip.background = element_blank(),
                 strip.text = element_text(face = "bold", size = 7)) +
           enrichplot_theme)
       }
       dev.off()

       saveRDS(
         p1,
         file = paste0(plots_directory, "/", pathwaydb, "_plot_", stat_test,
                       "_top10_", annotation_type, "_", test_type, ".rds"))
       print(p1)

     } else {
       print("No overlap between comparecluster_df and top10 Wilcoxon/KS")
     }

  } else {
    print("Wilcoxon/KS files cell or condition column name in results file not inputted in function")
  }
}

reactome_pathway_enrichment <- function(regulons_f = params$regulon_gene,
                                        pathway_db = "enrichPathway",
                                        maxGSSize = params$maxGSSize,
                                        pvalueCutoff = as.numeric(params$pvaluecutoff),
                                        qvalueCutoff = as.numeric(params$qvaluecutoff)) {
  regulon_genes <- read_csv(file = regulons_f)
  regulon_genes$genes <- gsub("[[:space:]]", "", regulon_genes$genes)    # note
  regulon_genes$genes_list <- (strsplit(regulon_genes$genes, ","))
  genes_list <-(regulon_genes$genes_list)
  names(genes_list) <- regulon_genes$regulon_name

  background <- read_csv(file = params$exp_matrix)

  if (params$species == "fly") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb = "org.Dm.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g = genes_list) %do% {
      id_df_g <- bitr(g, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Dm.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_id_list, universe = bg_id_v,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          organism = "fly", readable = T ,fun = pathway_db)
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "human") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb="org.Hs.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g = genes_list) %do% {
      id_df_g <- bitr(g, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Hs.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_id_list, pAdjustMethod = "BH",
                          pvalueCutoff = pvalueCutoff, qvalueCutoff = qvalueCutoff,
                          maxGSSize = maxGSSize, organism = "human", readable = T,
                          fun = pathway_db, universe = bg_id_v)
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "mouse") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb = "org.Mm.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g=genes_list) %do% {
      id_df_g <- bitr(g, fromType="SYMBOL", toType = "ENTREZID", OrgDb = "org.Mm.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_list, universe = bg_id_v,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          organim = "mouse", readable = T, fun = pathway_db)
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "None") {
    print("No species information provided and relevant Organism dbi needs to be loaded from Bioconductor")

  } else {
    print("Vurrent options are fly, human, mouse or None")
  }
}

kegg_pathway_enrichment <- function(regulons_f = params$regulon_gene,
                                    pathway_db = "enrichKEGG",
                                    maxGSSize = params$maxGSSize,
                                    pvalueCutoff = as.numeric(params$pvaluecutoff),
                                    qvalueCutoff = as.numeric(params$qvaluecutoff)) {
  regulon_genes <- read_csv(file = regulons_f)
  regulon_genes$genes <- gsub("[[:space:]]", "", regulon_genes$genes)    # note
  regulon_genes$genes_list <- (strsplit(regulon_genes$genes, ","))
  genes_list <- (regulon_genes$genes_list)
  names(genes_list) <- regulon_genes$regulon_name

  background <- read_csv(file=params$exp_matrix)

  if (params$species == "fly") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb = "org.Dm.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g = genes_list) %do% {
      id_df_g <- bitr(g, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Dm.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_id_list, universe = bg_id_v ,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          organism = "dme", fun = pathway_db, keyType = "ncbi-geneid")
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "human") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb = "org.Hs.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g = genes_list) %do% {
      id_df_g <- bitr(g, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Hs.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_id_list, pAdjustMethod = "BH",
                          pvalueCutoff = pvalueCutoff, qvalueCutoff = qvalueCutoff,
                          maxGSSize = maxGSSize, organism = "hsa", fun = pathway_db,
                          universe = bg_id_v, keyType = "ncbi-geneid")
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)
  } else if (params$species == "mouse") {
    bg_id <- bitr(background$X1, fromType = "SYMBOL", toType = "ENTREZID",
                  OrgDb = "org.Mm.eg.db")
    bg_id_v <- as.character(c(bg_id$ENTREZID))
    gene_id_list <- foreach(g = genes_list) %do% {
      id_df_g <- bitr(g, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Mm.eg.db")
      id_list_g <- as.character(c(id_df_g$ENTREZID))
    }
    names(gene_id_list) <- names(genes_list)

    res <- compareCluster(geneClusters = gene_list, universe = bg_id_v,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          organism = "mmu", fun = pathway_db, keyType = "ncbi-geneid")
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "None") {
    print("No species information provided and relevant Organism dbi needs to be loaded from Bioconductor")

  } else {
    print("Current options are fly, human, mouse or None")
  }
}

msigdb_pathway_enrichment <- function(regulons_f = params$regulon_gene,
                                      pathway_db = "enricher",
                                      maxGSSize = params$maxGSSize,
                                      pvalueCutoff = as.numeric(params$pvaluecutoff),
                                      qvalueCutoff = as.numeric(params$qvaluecutoff),
                                      msigdb_geneset = params$msigdb_geneset) {
  regulon_genes <- read_csv(file = regulons_f)
  regulon_genes$genes <- gsub("[[:space:]]", "", regulon_genes$genes)    # note
  regulon_genes$genes_list <- (strsplit(regulon_genes$genes, ","))
  genes_list <- (regulon_genes$genes_list)
  names(genes_list) <- regulon_genes$regulon_name

  background <- read_csv(file = params$exp_matrix)
  universe <- as.character(background$X1)
  rm(background)

  if (params$species == "fly") {
    m_t2g <- msigdbr(species = "Drosophila melanogaster", category = msigdb_geneset) %>%
      dplyr::select(gs_name, gene_symbol)

    res <- compareCluster(geneClusters = genes_list, universe = universe,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          fun = "enricher", TERM2GENE = m_t2g)
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db , "_regulons_results.rds"))
    return(res)

  } else if (params$species == "human") {
    m_t2g <- msigdbr(species = "Homo sapiens", category = msigdb_geneset) %>%
      dplyr::select(gs_name, gene_symbol)

    res <- compareCluster(geneClusters = genes_list, universe = universe,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          fun = "enricher", TERM2GENE = m_t2g)
    saveRDS(
      res,
      file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if(params$species == "mouse") {
    m_t2g <- msigdbr(species = "Mus musculus", category = msigdb_geneset) %>%
      dplyr::select(gs_name, gene_symbol)

    res <- compareCluster(geneClusters = genes_list, universe = universe,
                          pAdjustMethod = "BH", pvalueCutoff = pvalueCutoff,
                          qvalueCutoff = qvalueCutoff, maxGSSize = maxGSSize,
                          fun = "enricher", TERM2GENE = m_t2g)
    saveRDS(res,file = paste0(results_directory, "/", pathway_db, "_regulons_results.rds"))
    return(res)

  } else if (params$species == "None") {
    print("No species information provided and relevant Organism dbi needs to be loaded from Bioconductor")

  } else {
    print("Current options are fly, human, mouse or None")
  }
}

rss_pathway_plot <- function(rss_f = params$rss_celltype,
                             annotation_type = params$celltype,
                             plot_height = 8, plot_width = 8, units = "in",
                             showCategory = 8, pathwaydb = "GO_term", res_f = GO_res,
                             plot_row = 1, plot_col = 1) {
  if (annotation_type != "None") {
    comparecluster_df <- res_f@compareClusterResult
    rss_scores <- read_csv(file = rss_f)
    annotation_type <- as.character(annotation_type)
    colnames(rss_scores)[1] <- "annotation"

    rss_scores_long <- rss_scores %>%
      tidyr:: pivot_longer(-1, names_to = "Regulon", values_to = "RSS") %>%
      mutate(across(where(is_character), as_factor)) %>%
      group_by(annotation) %>%
      dplyr::arrange(desc(RSS), .by_group = T) %>%
      dplyr::slice(1:10) %>%
      dplyr::select(annotation, Regulon)

    cc_subset <- comparecluster_df %>%
      inner_join(rss_scores_long, by = c("Cluster" = "Regulon"))

    if (nrow(cc_subset) > 0) {
      gsize <- as.numeric(sub("/\\d+$", "", as.character(cc_subset$GeneRatio)))
      gcsize <- as.numeric(sub("^\\d+/", "", as.character(cc_subset$GeneRatio)))
      cc_subset$GeneRatio <- gsize/gcsize
      cluster <- paste(as.character(cc_subset$Cluster), "(", gcsize, ")", sep = "")
      lv <- unique(cluster)[order(as.numeric(unique(cc_subset$Cluster)))]
      cc_subset$Cluster <- factor(cluster, levels = lv)

      plot_data <- cc_subset %>%
        group_by(Cluster) %>%
        dplyr::arrange(p.adjust) %>%
        dplyr::slice(1:7)
      idx <-  order(plot_data$Cluster)
      plot_data$Description <- factor(plot_data$Description,
                                      levels = rev(unique(plot_data$Description[idx])))

      p1 <- ggplot(plot_data,
                   aes_string(x = "Cluster", y = "Description", color = "p.adjust"))
      p1 <- p1 +
        geom_point(aes(size = Count)) +
        theme(axis.text.y = element_text(size = 7),
              axis.text.x = element_text(size = 7, angle = 45, hjust = 1)) +
        scale_color_viridis_c(direction = 1, alpha = 0.8) +
        xlab("") +
        ylab("") +
        theme(legend.title = element_text(size = 7),
              legend.text = element_text(size = 7))
      p1 <- p1 +
        facet_wrap_paginate(.~ annotation, scales = "free", shrink = T,
                            nrow = plot_row, ncol = plot_col, page = 1)
      num_pages <- n_pages(p1)

       pdf(paste0(plots_directory, "/", pathwaydb, "_plot_RSS_scores_top10_",
                  annotation_type, ".pdf"),
           height = plot_height, width = plot_width)
       for (i in 1:num_pages) {
         print(p1 +
               facet_wrap_paginate(.~ annotation, scales = "free", shrink = T,
                                   nrow = plot_row, ncol = plot_col, page = i) +
           theme(strip.background = element_blank(),
                 strip.text = element_text(face = "bold", size = 7)) +
           enrichplot_theme)
       }
       dev.off()

      saveRDS(
        p1,
        file = paste0(plots_directory, "/", pathwaydb, "_plot_RSS_scores_top10_",
                      annotation_type, ".rds"))
      print(p1)

    } else {
      print("No overlap between comparecluster_df and RSS top 10")
    }

  } else {
    print("Annotation type not inputted")
  }
}
```

# Celltype or condition specific heatmaps based on Z scores

## Celltype

```{r, fig.height = 8, fig.width = 8}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$celltype != "None") {
  zscores_celltype <- read.csv(file = params$zscores_celltype, header = T)
  zscore_heatmap(zscores_df = zscores_celltype,
                 plot_height = 9, plot_width = 8,
                 filter_threshold = params$zscore_filter_threshold_celltype,
                 annotation_type = params$celltype)
} else {
  print("No celltypes were provided")
}
```

## Condition

```{r}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$condition != "None" & params$zscore_filter_threshold_condition !="None") {
  zscores_condition <- read.csv(file = params$zscores_condition, header = T)
  zscore_heatmap(zscores_df = zscores_condition,
                 plot_height = 6, plot_width = 9,
                 annotation_type = params$condition,
                 filter_threshold = params$zscore_filter_threshold_condition)
} else {
  print("No condition only Z score file provided")
}
```

## Celltype + condition

```{r, fig.height = 15, fig.width = 10}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$celltype_condition != "None") {
  zscores_celltype_condition <- read.csv(file = params$zscores_celltype_condition, header = T)
  zscore_heatmap(zscores_df = zscores_celltype_condition,
                 plot_height = 15, plot_width = 10,
                 annotation_type = params$celltype_condition,
                 filter_threshold = params$zscore_filter_threshold_celltype_condition)
} else {
  print("No celltype + condition Z score file provided")
}
```

# Celltype or condition specific heatmaps based on binarization matrix

 + Binarized version (~ percentage of cells from given *celltype/condition* with the regulon *active* or *on*)

## Celltype

```{r, fig.height = 9, fig.width = 12}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$celltype != "None"){
  binary_celltype_perc_heatmap(cellInfo_f = params$annotation_celltype,
                               binary_mtx_f = params$binary_mtx,
                               minPerc = 0.70,
                               annotation_type = params$celltype,
                               plot_height = 7, plot_width = 10, units = "in")
} else {
  print("No celltype information provided in the parameters so analysis not run")
}
```

## Condition

```{r, fig.height = 4, fig.width = 6}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$condition != "None") {
  binary_celltype_perc_heatmap(plot_height = 4, plot_width = 6,
                               annotation_type = params$condition,
                               cellInfo_f = params$annotation_condition,
                               minPerc = 0.60, cluster_rows = F, cluster_cols = F)
} else {
  print("No condition information provided in the parameters")
}
```

## Cell + Condition

```{r, fig.height = 6, fig.width = 8}
# "annotation_type" in function giving the type of annotation
# options: celltype, condition or celltype_condition
# This is based on the 2nd column name in params$annotation_celltype file
if (params$celltype_condition != "None") {
  binary_celltype_perc_heatmap(plot_height = 10, plot_width = 15,
                               annotation_type = params$celltype_condition,
                               cellInfo_f = params$annotation_celltype_condition,
                               minPerc = 0.70)
} else {
  print("No celltype + condition information provided in the parameters")
}
```

# Binary AUC score Heatmap

```{r, fig.width = 12, fig.height = 11}
binary_auc_heatmap(annotation_col_f = params$binary_heatmap_cell_annotations,
                   plot_height = 10, binary_mtx_f = params$binary_mtx)
```

# RSS score based regulons

## Celltype specific

```{r, fig.height = 6, fig.width = 8}
# annotation_type is used to name saved plots and RDS objects, can be anything the user wants
if (params$celltype != "None") {
  RSS_annotation_plot(annotation_type = params$celltype,
                      rss_f = params$rss_celltype,
                      units = "in", plot_height = 6, plot_width = 8)
} else {
  print("No celltype information provided")
}
```

## Condition specific

```{r, fig.height = 3, fig.width = 4}
# annotation_type is used to name saved plots and RDS objects, can be anything the user wants
if (params$condition != "None") {
  RSS_annotation_plot(annotation_type = params$condition,
                      rss_f = params$rss_condition,
                      units = "in", plot_height = 4, plot_width = 5)
} else {
  print("No condition specific information provided")
}
```

## Celltype + condition specific

```{r, fig.height = 8, fig.width = 10}
# annotation_type is used to name saved plots and RDS objects, can be anything the user wants
if (params$celltype_condition != "None") {
  RSS_annotation_plot(annotation_type = params$celltype_condition,
                      rss_f = params$rss_celltype_condition,
                      units = "in", plot_height = 12, plot_width = 12)
} else {
  print("No celltype + condition information provided")
}
```

# Binary Regulon activity summary

## Celltype

```{r, fig.width = 10, fig.height = 3}
# annotation_type has to be "celltype"
if (params$celltype != "None") {
  num_active_regulons_annotation(cellInfo_f = params$annotation_celltype,
                                 binary_mtx_f = params$binary_mtx,
                                 annotation_type = params$celltype,
                                 units = "in", plot_height = 4,plot_width = 12)

  num_annotation_per_regulon(cellInfo_f = params$annotation_celltype,
                             binary_mtx_f = params$binary_mtx,
                             annotation_type = params$celltype,
                             units = "in", plot_height = 4, plot_width = 11)
} else {
  print ("No celltype information provided")
}
```

## Condition

```{r}
# annotation_type has to be "condition"
if(params$condition != "None") {
  num_active_regulons_annotation(cellInfo_f = params$annotation_condition,
                                 binary_mtx_f = params$binary_mtx,
                                 annotation_type = params$condition,
                                 units = "in", plot_height = 3, plot_width = 4)
}
```

```{r, fig.height = 4, fig.width = 10}
# annotation_type has to be "condition"
if (params$condition != "None") {
  num_annotation_per_regulon(cellInfo_f = params$annotation_condition,
                             binary_mtx_f = params$binary_mtx,
                             annotation_type = params$condition,
                             units = "in", plot_height = 4, plot_width = 11)
}
```

## Celltype + condition

```{r, fig.width = 5, fig.height = 2}
# annotation_type has to be "celltype_condition"
if (params$celltype_condition != "None") {
  num_active_regulons_annotation(cellInfo_f = params$annotation_celltype_condition,
                                 binary_mtx_f = params$binary_mtx,
                                 annotation_type = params$celltype_condition,
                                 units = "in", plot_height = 3,plot_width = 6)
}
```

```{r, fig.height = 3, fig.width = 10}
# annotation_type has to be "celltype_condition"
if (params$celltype_condition != "None"){
  num_annotation_per_regulon(cellInfo_f = params$annotation_celltype_condition,
                             binary_mtx_f = params$binary_mtx,
                             annotation_type = params$celltype_condition,
                             units = "in", plot_height = 4, plot_width = 11)
}
```

# Gene over-representation analysis of regulon target genes

## GO Biological Process

```{r}
GO_res <- regulon_pathway_enrichment(regulons_f = params$regulon_genes,
                                     ont_option = params$go_ont_option,
                                     pathway_db = "enrichGO",
                                     maxGSSize = params$maxGSSize)
saveRDS(GO_res, paste0(results_directory, "/GO_res.rds"))
```

### Top 10 wilcoxon regulons by celltype (one vs all)

```{r, fig.height = 7, fig.width = 8}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_celltype_top,
                        annotation_type = "test_cell_type", test_type = "one_vs_all",
                        plot_height = 10, plot_width = 11, units = "in",
                        showCategory = 7, stat_test = "wilcoxon",
                        pathwaydb = "GO_term", res_f = GO_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 wilcoxon regulons by condition (compared to reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_condition_top,
                        annotation_type = "test_condition", test_type = "reference",
                        plot_height = 6, plot_width = 8, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "GO_term",
                        res_f = GO_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS regulons by celltype (one vs all)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_celltype_top,
                        annotation_type = "test", test_type = "one_vs_all",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_celltype", pathwaydb = "GO_term",
                        res_f = GO_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS test regulons by condition (compared to reference)

```{r,fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_condition_top,
                        annotation_type = "test", test_type = "reference",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_condition", pathwaydb = "GO_term",
                        res_f = GO_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype)

```{r, fig.height = 8, fig.width = 10}
if (params$celltype != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype,
                   annotation_type = params$celltype,
                   showCategory = 8, pathwaydb = "GO_term", res_f = GO_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (condition)

```{r, fig.height = 6, fig.width = 8}
if (params$condition != "None") {
  rss_pathway_plot(rss_f = params$rss_condition,
                   annotation_type = params$condition,
                   showCategory = 8, pathwaydb = "GO_term", res_f = GO_res,
                   plot_height = 6, plot_width = 8, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype + condition)

```{r, fig.height = 8,fig.width = 10, eval = T}
if (params$celltype_condition != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype_condition,
                   annotation_type = params$celltype_condition,
                   showCategory = 8, pathwaydb = "GO_term", res_f = GO_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

## Reactome pathways

```{r}
Reactome_res <- reactome_pathway_enrichment(regulons_f = params$regulon_genes,
                                            pathway_db = "enrichPathway",
                                            maxGSSize = params$maxGSSize)
saveRDS(Reactome_res, paste0(results_directory, "/Reactome_res.rds"))
```

### Top 10 wilcoxon regulons by celltype (one vs all)

```{r, fig.height = 8, fig.width = 8}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_celltype_top,
                        annotation_type = "test_cell_type", test_type = "one_vs_all",
                        plot_height = 10, plot_width = 11, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "Reactome",
                        res_f = Reactome_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 wilcoxon regulons by condition (compared to reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_condition_top,
                        annotation_type = "test_condition", test_type = "reference",
                        plot_height = 6, plot_width = 8, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "Reactome",
                        res_f = Reactome_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS regulons by celltype (one vs all)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_celltype_top,
                        annotation_type = "test", test_type = "one_vs_all",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_celltype", pathwaydb = "Reactome",
                        res_f = Reactome_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS test regulons by condition (reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_condition_top,
                        annotation_type = "test", test_type = "reference",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_condition",
                        pathwaydb = "Reactome", res_f = Reactome_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype)

```{r, fig.height = 8, fig.width = 10}
if (params$celltype != "None") {
 rss_pathway_plot(rss_f = params$rss_celltype,
                  annotation_type = params$celltype,
                  showCategory = 8, pathwaydb = "Reactome", res_f = Reactome_res,
                  plot_height = 8, plot_width = 10, units = "in",
                  plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (condition)

```{r, fig.height = 6, fig.width = 8}
if (params$condition != "None") {
  rss_pathway_plot(rss_f = params$rss_condition,
                   annotation_type = params$condition,
                   showCategory = 8, pathwaydb = "Reactome", res_f = Reactome_res,
                   plot_height = 6, plot_width = 8, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype + condition)

```{r, fig.height = 8, fig.width = 10, eval = T}
if (params$celltype_condition != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype_condition,
                   annotation_type = params$celltype_condition,
                   showCategory = 8, pathwaydb = "Reactome", res_f = Reactome_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

## MSigDB C2 curated pathways

```{r}
msigdb_c2_res <- msigdb_pathway_enrichment(regulons_f = params$regulon_genes,
                                           pathway_db = "enricher",
                                           maxGSSize = params$maxGSSize,
                                           msigdb_geneset = params$msigdb_geneset)
saveRDS(msigdb_c2_res, paste0(results_directory, "/msigdb_c2_res.rds"))
```

### Top 10 wilcoxon regulons by celltype (one vs all)

```{r, fig.height = 7, fig.width = 8}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_celltype_top,
                        annotation_type = "test_cell_type", test_type = "one_vs_all",
                        plot_height = 10, plot_width = 11, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "msigdb_curated",
                        res_f = msigdb_c2_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 wilcoxon regulons by condition (compared to reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_condition_top,
                        annotation_type = "test_condition", test_type = "reference",
                        plot_height = 6, plot_width = 8, units = "in",
                        showCategory = 7, stat_test = "wilcoxon",
                        pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 KS regulons by celltype (one vs all)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_celltype_top,
                        annotation_type = "test", test_type = "one_vs_all",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_celltype",
                        pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 KS test regulons by condition (reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_condition_top,
                        annotation_type = "test", test_type = "reference",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_condition",
                        pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype)

```{r, fig.height = 8, fig.width = 10}
if (params$celltype != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype,
                   annotation_type = params$celltype, showCategory = 8,
                   pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (condition)

```{r, fig.height = 6, fig.width = 8}
if (params$condition != "None") {
  rss_pathway_plot(rss_f = params$rss_condition,
                   annotation_type = params$condition, showCategory = 8,
                   pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                   plot_height = 6, plot_width = 8, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype + condition)

```{r, fig.height=8,fig.width=10, eval=T}
if (params$celltype_condition != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype_condition,
                   annotation_type = params$celltype_condition, showCategory = 8,
                   pathwaydb = "msigdb_curated", res_f = msigdb_c2_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

## KEGG pathways

```{r}
KEGG_res <- kegg_pathway_enrichment(regulons_f = params$regulon_genes,
                                    pathway_db = "enrichKEGG",
                                    maxGSSize = params$maxGSSize)
saveRDS(KEGG_res, paste0(results_directory, "/KEGG_res.rds"))
```

### Top 10 wilcoxon regulons by celltype (one vs all)

```{r, fig.height = 8, fig.width = 8}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_celltype_top,
                        annotation_type = "test_cell_type", test_type = "one_vs_all",
                        plot_height = 10, plot_width = 11, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "KEGG",
                        res_f = KEGG_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 wilcoxon regulons by condition (compared to reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$wilcoxon_condition_top,
                        annotation_type = "test_condition", test_type = "reference",
                        plot_height = 6, plot_width = 8, units = "in",
                        showCategory = 7, stat_test = "wilcoxon", pathwaydb = "KEGG",
                        res_f = KEGG_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS regulons by celltype (one vs all)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$celltype != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_celltype_top,
                        annotation_type = "test", test_type = "one_vs_all",
                        plot_height = 7, plot_width = 10, units = "in",
                        showCategory = 7, stat_test = "KS_celltype", pathwaydb = "KEGG",
                        res_f = KEGG_res, plot_row = 1, plot_col = 1)
}
```

### Top 10 KS test regulons by condition (reference)

```{r, fig.height = 4, fig.width = 6}
# annotation_type is the column names from wilcoxon or KS results file with celltype or condition annotation
if (params$condition != "None") {
  wilcoxon_pathway_plot(wilcoxon_f = params$ks_condition_top,
                        annotation_type = "test", test_type = "reference",
                        plot_height = 7, plot_width = 10, units = "in", showCategory = 7,
                        stat_test = "KS_condition", pathwaydb = "KEGG", res_f = KEGG_res,
                        plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype)

```{r, fig.height = 8, fig.width = 10}
if (params$celltype!= "None") {
  rss_pathway_plot(rss_f = params$rss_celltype,
                   annotation_type = params$celltype, showCategory = 8,
                   pathwaydb = "KEGG", res_f = KEGG_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (condition)

```{r, fig.height = 6, fig.width = 8}
if (params$condition != "None") {
  rss_pathway_plot(rss_f = params$rss_condition,
                   annotation_type = params$condition, showCategory = 8,
                   pathwaydb = "KEGG", res_f = KEGG_res,
                   plot_height = 6, plot_width = 8, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

### Top 10 RSS regulons (celltype + condition)

```{r, fig.height = 8, fig.width = 10, eval = T}
if (params$celltype_condition != "None") {
  rss_pathway_plot(rss_f = params$rss_celltype_condition,
                   annotation_type = params$celltype_condition, showCategory = 8,
                   pathwaydb = "KEGG", res_f = KEGG_res,
                   plot_height = 8, plot_width = 10, units = "in",
                   plot_row = 1, plot_col = 1)
}
```

# Session info

```{r session_info}
sessionInfo()
```
